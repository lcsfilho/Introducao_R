---
title: "Presentation Ninja"
subtitle: "&#x2694;&#xFE0F; xaringan +<br/>&#x1F60E; xaringanthemer"  
author: 
  - "Yihui Xie"
  - "Garrick Aden-Buie"
date: '`r Sys.Date()`'
output:
  xaringan::moon_reader:
    lib_dir: libs
    seal: false
    css: Curso_R.css
    fig_caption: true
    number_sections: true
    nature:
      slideNumberFormat: "%current%"
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
      countIncrementalSlides: true

---
layout: true


```{r, load_refs, include=FALSE, cache=FALSE}
#install.packages("RefManageR")
#install.packages("bibtex")

library(RefManageR)
RefManageR::BibOptions(
  check.entries = FALSE,
  style = "markdown",
  cite.style = "authoryear",
  bib.style = "authoryear"
)
referencias <- RefManageR::ReadBib("referencias.bib", check = FALSE)
```


<img src="https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/fig/BrasaoGoverno.png?raw=true" style="left: 5px; top: 5px; position: absolute" width="7.5%" height="13%">

 
 <img src="https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/fig/UCS.PNG?raw=true" style="right: 20px; top: 5px; position: absolute" width="6%" height="14%">

 <img src="https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/fig/LinhaVertical.PNG?raw=true" style="right: 0px; top: 0px; position: absolute" width="1.5%" height="99.7%">
 
  <img src="https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/fig/LinhaHorizontal.PNG?raw=true" style="left: -1px; bottom: 0px; position: absolute" width="99.3%" height="2.5%">

---
class: center, middle

# Introdução ao Software R e ao R Markdown

Luiz Carlos Santana Filho
<p style="font-size: 12px">
Diretoria de Planejamento Social</p>
<p style="font-size: 12px">Superintendência de Planejamento Estratégico</p>
<p style="font-size: 15px">Secretaria do Planejamento</p>

<p style="color: blue; font-size: 14px; margin: 5px"><i>luizcarlos.santanafilho@seplan.ba.gov.br</i></p>

[https://github.com/lcsfilho](https://github.com/lcsfilho)


 <img src="https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/fig/FigR_RStudio_RMarkdown.png?raw=true" style="left: auto; right=auto; bottom:-100px; position: relative" width="40%" height="1.7%">

---
<div class="titulo" position="Center">Introdução ao Software R e ao R Markdown</div>

```{r echo=FALSE, message=FALSE, warning=FALSE}
require("magrittr")

file_name <- rstudioapi::getSourceEditorContext()[["path"]]

doc <- toc <- readLines(file_name)
tocc <- character()
for (i in 1:length(toc)) {
  if(substr(toc[i][1], 1, 2) == "# ") {
    toc[i] <- gsub("# ", "", toc[i], fixed = TRUE) %>% 
                gsub("#", "", ., fixed = TRUE)
    tocc <- append(tocc, toc[i])
  }
}

tocc <- paste("- ", tocc[-1])

row_outline <- which(doc == "# Índice")
row_body <- which(doc == "---")
row_body <- row_body[which(row_body > row_outline)][1]

doc <- c(doc[1:row_outline], "\n", tocc, "\n", doc[(row_body):length(doc)])


writeLines(doc, file_name)

```
<br>

# Índice


-  Índice
-  O que é o `R`?
-  Definições
-  Iniciação
-  Dados no `R`
-  Importando dados no R
-  Carregando dados
-  Análise descritiva (unidimensional)
-  Pacote Tidyverse
-  Mapas
-  Malha digital da Bahia por municípios
-  Malha digital da Bahia por mesorregiões
-  Malha digital da Bahia por microrregiões
-  Referências


---

layout: true

<div class="titulo" position="Center">Introdução ao Software R e ao R Markdown</div>


<img src="https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/fig/BrasaoGoverno.png?raw=true" style="left: 5px; top: 5px; position: absolute" width="7.5%" height="13%">

 
<img src="https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/fig/UCS.PNG?raw=true" style="right: 20px; top: 5px; position: absolute" width="6%" height="14%">

<img src="https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/fig/LinhaVertical.PNG?raw=true" style="right: 0px; top: 0px; position: absolute" width="1.5%" height="99.7%">
 
<img src="https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/fig/LinhaHorizontal.PNG?raw=true" style="left: -1px; bottom: 0px; position: absolute" width="99.3%" height="2.5%">

---
<center><font size="6">Bibliografia básica</font></center>

<div class="container">


<img src="https://images-submarino.b2w.io/produtos/134528441/imagens/livro-r-para-data-science-importe-arrume-transforme-visualize-e-modele-dados/134528441_1_large.jpg" style="left: auto; top: 25%; position: absolute" width="20%">


<img src="http://www.cookbook-r.com/r_graphics_cookbook.png" style="left: 41%; top: 25%; position: absolute" width="18%">


<img src="https://bookdown.org/yihui/rmarkdown-cookbook/images/cover.png" style="right: 10%; top: 25%; position: absolute" width="12.5%">


<div class="bibliografia">

.pull-left[
> [R para Data Science](https://www.amazon.com.br/para-data-science-transforme-visualize/dp/8550803243/ref=asc_df_8550803243/?tag=googleshopp00-20&linkCode=df0&hvadid=379736468109&hvpos=&hvnetw=g&hvrand=4984106143229360944&hvpone=&hvptwo=&hvqmt=&hvdev=c&hvdvcmdl=&hvlocint=&hvlocphy=1001533&hvtargid=pla-811060137763&psc=1)<br>
> [R Graphics Cookbook](https://www.amazon.com.br/Graphics-Cookbook-2e-Winston-Chang/dp/1491978600/ref=asc_df_1491978600/?tag=googleshopp00-20&linkCode=df0&hvadid=379787555408&hvpos=&hvnetw=g&hvrand=5700521040944184438&hvpone=&hvptwo=&hvqmt=&hvdev=c&hvdvcmdl=&hvlocint=&hvlocphy=1001533&hvtargid=pla-422014417858&psc=1/)<br>
> [R Markdown Cookbook (WEB)](https://bookdown.org/yihui/rmarkdown-cookbook/)<br>
> [R Markdown Cookbook (PDF)](https://bookdown.org/yihui/rmarkdown-cookbook/rmarkdown-cookbook.pdf)<br>
> [Ciência de Dados em R - Curso R](https://livro.curso-r.com/)

]

.pull-right[
> [Cookbook for R](http://www.cookbook-r.com/)<br>
> [Aprendendo R - Fiocruz](http://www.de.ufpb.br/~tatiene/Disciplinas/2014.2/LivroR/aprendendo_r.pdf)<br>
> [An Introduction to R](https://cran.r-project.org/doc/manuals/R-intro.pdf)<br>
> [Using R for Data Analysis and Graphics](https://cran.r-project.org/doc/contrib/usingR.pdf)<br>
> [Visualização de dados com ggplot2](http://leg.ufpr.br/~walmes/cursoR/data-vis/slides/08-ggplot2.pdf)<br>

]


[Livros R gratuitos para download](https://producaoanimalcomr.wordpress.com/2015/12/15/livros-r-gratuitos-para-downloads/)


</div>
</div>
---
background-image: url(https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/fig/R_logo.png?raw=true)
background-size: 45px
background-position: 50% 16%

# O que é o `R`?


- R é uma linguagem e um ambiente de desenvolvimento integrado, para cálculos estatísticos e gráficos.

- Foi criada originalmente por [_Ross Ihaka_](https://pt.wikipedia.org/w/index.php?title=Ross_Ihaka&action=edit&redlink=1) e por [_Robert Gentleman_](https://pt.wikipedia.org/w/index.php?title=Robert_Gentleman&action=edit&redlink=1) no departamento de Estatística da universidade de Auckland, Nova Zelândia, e foi desenvolvido por um esforço colaborativo de pessoas em vários locais do mundo.

- O nome R provêm em parte das iniciais dos criadores e também de um jogo figurado com a linguagem `S` (da Bell Laboratories, antiga AT&T).

- R é uma linguagem e ambiente similar ao [S](https://pt.wikipedia.org/wiki/S_(linguagem_de_programa%C3%A7%C3%A3o) - pode ser considerado uma implementação distinta do S; embora com importantes diferenças, muitos códigos escritos para o S rodam inalterados no R. A implementação comercial de S é [S-PLUS](https://www.splus.iag.usp.br/).

- O código fonte do `R` está disponível sob a licença [GNU](https://www.gnu.org/) [GPL](https://pt.wikipedia.org/wiki/GNU_General_Public_License) e as versões binárias pré-compiladas são fornecidas para Windows, Macintosh, e muitos sistemas operacionais Unix/Linux.

- `R` é também altamente expansível com o uso dos pacotes, que são bibliotecas para funções específicas ou áreas de estudo específicas.

[Blog Software Livre na Educação](https://www.ufrgs.br/soft-livre-edu/software-educacional-livre-na-wikipedia/r-linguagem-de-programacao/)

---
<div class="Ross_Ihaka">
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f0/Ross_Ihaka_%285189180796%29.jpg/220px-Ross_Ihaka_%285189180796%29.jpg" style="left: 17%; top: 30%; position: absolute" width="35%" height="40%" >
<p>Ross Ihaka</p>
</div>


<div class="Robert_Gentleman">
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c6/Rober_Gentleman.png/220px-Rober_Gentleman.png" style="right: 16%; top: 30%; position: absolute"width="23%" height="40%" >
<p>Robert Gentleman</p>
</div>

---
<center>
<figure>
<img src="https://revolution-computing.typepad.com/.a/6a010534b1db25970b01b8d2594d25970c-800wi" style="left: 25%; top: 20%; position: absolute"width="50%">
<figcaption>Número de pacotes R publicados no Repositório CRAN</figcaption>
</figure>
</center>

---
# Definições

* Objeto: `R` é uma linguagem orientada a objetos e tudo em R é um objeto. Trata-se de uma referência a um local da memória que possui um valor.
Por exemplo, um único número é um objeto, uma variável é um objeto, a saída é um objeto, um conjunto de dados é um objeto que é, por si próprio, uma coleção de objetos, etc.

* Vetor: Uma coleção de um ou mais objetos do mesmo tipo. Por exemplo, todos os números ou todos os caracteres.

* Função: Um conjunto de instruções realizadas em um ou mais objetos. Funções são normalmente utilizadas para executar tarefas específicas e comuns, que normalmente exigiriam muitas instruções.
Por exemplo, a função `mean()` (média) é usada para calcular a média aritmética dos valores de um vetor numérico.

* Argumento: Informação específica (na forma name = value) passada para uma função para determinar como ela deve desempenhar a sua tarefa. Por exemplo, a função `mean()` requer, pelo menos, um argumento - o nome de um objeto que contém os valores a partir dos quais a média será calculada.

* Operador: Um símbolo com significado pré-definido. Os operadores
comuns incluem +, −, ∗, /, ˆ, e os operadores lógicos
<, >, <=, >=, ==, !=, &&, ||.

`r RefManageR::TextCite(referencias, "andreluis")`

---
# Iniciação

<img src="https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/fig/TelaR.PNG?raw=true" style="right: 3%; top: 35%; position: absolute"width="45%">


1. Acesse o endereço https://www.r-project.org e baixe o `R` por uma das URLs disponíveis (CRAN<sup>1</sup> Mirrors)
1. Instale o software `R` (`R-Gui`)
1. Execute o software `R` (`R-Gui`)

.pull-left[
"O sistema é formado por um programa básico (`R-Gui`) e muitos pacotes com procedimento adicionais. Tudo é gratuito e com código livre, voltado para comunidade acadêmica."
`r RefManageR::Cite(referencias, "lingR")`

Ao executar, o software `R` abre o console com informações e avisos, seguidos pelo prompt de comando (<font color="#F2A025"> > </font>).
]

.footnote[
[1] [Comprehensive R Archive Network](https://cran.r-project.org/mirrors.html)
]

---
## Explorando o R

Operações básicas no R

<img src="https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/fig/Operacoes_R.PNG?raw=true" style="right: auto; top: 35%; position: absolute"width="40%">
<br><br><br><br><br><br><br><br><br><br><br><br><br><br>
O símbolo <font color="#F2A025"> # </font> é usado para comentário no R.



---
## Criando vetores

Criando uma sequência de números de 0 a 20:

```{r collapse = TRUE}
x = 0 : 20
x
```

Acessando o 6º elemento do vetor:

```{r collapse = TRUE}
x [6]
```

Alterando dados:

```{r collapse = TRUE}
x [1] = 20
x
```
---
Há outra forma de criar vetores, utilizando a função `c()`.
Vamos gerar uma sequência numérica de 0 a 10.

```{r collapse = TRUE}

x = c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10)
x
```

Também podemos criar vetor de caracteres:

```{r collapse = TRUE}
y = c("A", "B", "C", "D", "E")
y
```

Criando uma matriz:
```{r collapse = TRUE}
matriz <- matrix(c(1, 2, 3, 4), nrow = 2, ncol = 2)
matriz
```
---
Para criar uma lista:


```{r collapse = TRUE}
list(2, 5, "A", TRUE, FALSE)

```

Também podemos trabalhar com `data frames`, que são objetos semelhantes a uma matriz, mas as suas colunas têm nomes e podem conter tipos de dados diferentes.

---
## Gráficos

Para criar um gráfico, precisamos dos dados. Na seção anterior, criamos uma sequência numérica atribuída à variável `x`. Agora, criaremos a varável `y` para fazer par com a variável `x`.

```{r fig.height=5, fig.align='center', collapse = TRUE}
y = 5 + 2*x^2
plot(x,y)
```

---
background-image: url(https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/gif/matematica.gif?raw=true)
background-size: 35%
background-position: 85% 80%

## Estatísticas

.pull-left[
Funções isoladas:
```{r collapse = TRUE}
mean(x)      #Média
median(x)    #Mediana
quantile(x)  #Quartis
var(x)       #Variância
sd(x)        #Desvio Padrão
min(x)       #Mínimo
max(x)       #Máximo
sum(x)       #Somatório

```
]

.pull-right[
Função summary()
```{r collapse = TRUE}
summary(x)
```
]

---
## Pacotes (Bibliotecas)

- Um `pacote` é uma coleção de funções, dados e documetações, que ampliam as funcionalidades básicas do `R`.

- A instalação básica do `R` já contém vários pacotes.

- Há milhares de pacotes gratúitos para instalação, que não fazem parte da instalção básica do `R`.


Pacotes podem ser instalados e carregados pelas funções `install.packages()` e `library()`, respectivamente.

Exemplo: Vamos instalar e carregar um pacote de gráficos chamado `ggplot`.

```{r eval=FALSE}
install.packages("ggplot2")
library(ggplot2)
```

Repare que o nome do pacote deve estar escrito entre aspas para a instalação, mas, para carregar, as aspas devem ser dispensadas.

Ao instalar um pacote, este deve ser carregado (`library()`) toda vez que o `R` for iniciado.

---
background-image: url(https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/fig/Help.PNG?raw=true)
background-size: 41%
background-position: 50% 88%

## Help

Para obter ajuda sobre qualquer função, basta escrever no `console` o nome da função (ou do pacote) precedido de uma interrogação: `?ggplot`. A outra opção é `help(ggplot)`.

Também podemos acessar a área de Help do `R Studio` e escrever o nome da função no campo indicado na figura


---

background-image: url(https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/fig/RStudio.jpg?raw=true)
background-size: 150px
background-position: 50% 16%

## R Studio

O [R Studio ](https://posit.co/) "é um software livre de ambiente de desenvolvimento integrado para `R`, uma linguagem de programação para gráficos e cálculos estatísticos."  `r RefManageR::Cite(referencias, "RStudio")`. É uma interface para uso do `R` e deve ser instalado após a instalação do `R`. Sua instalação se dá pelo endereço https://posit.co/.

<div style="float:left"><br><br><br><br><br>Scripts<br>
Funções<br>
<br><br><br><br>
Objetos<br>
Valores<br>
Funções ativas
</div>


<div style="float:right">Console<br>
Terminal<br><br><br>
  Background Jobs<br><br><br>
Files<br>
Plot<br>
Packages<br><br><br>
Help<br>
Viewer</div>

<img src="https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/gif/seta-imagem-animada-0032.gif?raw=true" style="left: 15%; top: 60%; position: absolute"width="5%">


<img src="https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/gif/seta-imagem-animada-0032.gif?raw=true" style="left: 15%; top: 85%; position: absolute"width="5%">


<img src="https://github.com/lcsfilho/Introducao_R/blob/faa0293cb8164941fa87551756cf3ea421c867ef/Curso%20R/fig/telaRStudio.PNG?raw=true" style="left: 20%; top: 38%; position: absolute"width="60%">

<img src="https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/gif/seta-imagem-animada-0044.gif?raw=true" style="left: 80%; top: 50%; width=5%; position: absolute">


<img src="https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/gif/seta-imagem-animada-0044.gif?raw=true" style="left: 80%; top: 80%; width=5%; position: absolute">

---
background-image: url(https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/gif/giphy.gif?raw=true)
background-size: 35%
background-position: 90% 50%

## Vantagens do RStudio


- Highlight do código;

- Autocomplete;

- Match automático de parenteses e chaves;

- Interface intuitiva para objetos, gráficos e script;

- Criação de "projetos" com interface para controle de versão;

- Facilidade na criação de pacotes;

- Interação com HTML, entre outras.


[Análise Real - Economia: Teoria, Prática e Política](https://analisereal.com/2015/01/20/r-e-rstudio-2/)

---

background-image: url(https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/fig/RCloud.PNG?raw=true)
background-size: 71%
background-position: 50% 92%

## R Studio Cloud

<img src="https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/fig/positCloud.svg?raw=true" style="left: 23%; top: 16%; position: absolute"width="20%">

Pode ser acessado a partir de qualquer computador ligado à internet; pode ser acessado pelo celular; todos os pacotes já estão instalados; possibilidade de compartilhar projetos; opção de usar gratuitamente, porém com limitações de memória e tempo de uso por mês.

---

background-image: url(https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/fig/TabelaDados.PNG?raw=true)
background-size: 25%
background-position: 50% 55%

# Dados no `R`

Vamos criar um conjunto de dados aleatório de 8 pessoas, com 4 variáveis: peso, altura, idade e renda. Perceba que a renda de uma pessoa não foi medida (dado _missing_).

<br><br><br><br><br><br><br><br><br>

```{r collapse = TRUE}
#Criando os vetores de variáveis pela função c()
peso = c(55, 70, 76, 80, 62, 51, 68, 74)
idade = c(27, 40, 36, 60, 42, 24, 35, 39)
altura = c(1.60, 1.72, 1.65, 1.75, 1.55, 1.63, 1.72, 1.58)
renda = c(2000, 5000, 4000, 3000, 1500, NA, 7000, 4500)
```

---
## Dados no `R`

A depender da função a presença do `NA` pode causar problemas

```{r collapse = TRUE}
sum(renda)
```

```{r collapse = TRUE}
mean(renda)
```

```{r collapse = TRUE}
min(renda)
```


```{r collapse = TRUE}
summary(renda)
```
---
## Dados no `R`

Usamos a função `c()` (concatenar) para agrupar os dados, criando vetores separados. Agora, usaremos as funções `cbind` (<u>c</u>olumn) e `rbind` (<u>r</u>ow) para concatenar os vetores em linhas e colunas.

Podemos agrupar as 4 variáveis em colunas, da seguinte forma:

```{r collapse = TRUE}
dados_pessoas = cbind(peso, idade, altura, renda)
dados_pessoas
```

---
## Dados no `R`

Podemos recuperar dados de colunas, linhas, dados individuais ou um conjunto de dados selecionados.

Acessando dados da 1ª coluna:

.pull-left[
```{r collapse = TRUE}
dados_pessoas[,1]
```

Acessando dados da 3ª linha:
```{r collapse = TRUE}
dados_pessoas[3,]
```

Acessando dado da 2ª linha e 3ª coluna:
```{r collapse = TRUE}
dados_pessoas[2,3]
```
]

.pull-right[
Acessando dados das linhas 2 a 4, na coluna 1:
```{r collapse = TRUE}
dados_pessoas[2:4,1]
```

Acessando todos os dados das linhas 1, 2 e 4:
```{r collapse = TRUE}
dados_pessoas[c(1, 2, 4),]
```
]
---
## Dados no `R`
Função `matrix()`
.pull-left[
Criando matriz de dimensão 8 x 4:

```{r}
dados_pessoas.M = matrix(nrow = 8, ncol = 4)
dados_pessoas.M
```
]


.pull-right[
Vamos alimentar a matriz com os dados das pessoas

```{r}
dados_pessoas.M[,1] = c(55, 70, 76, 80, 62, 51, 68, 74)
dados_pessoas.M[,2] = c(27, 40, 36, 60, 42, 24, 35, 39)
dados_pessoas.M[,3] = c(1.60, 1.72, 1.65, 1.75, 1.55, 1.63, 1.72, 1.58)
dados_pessoas.M[,4] = c(2000, 5000, 4000, 3000, 1500, NA, 7000, 4500)
dados_pessoas.M
```

]
---
## Dados no `R`
Função `data.frame()`

O _Data Frame_ é uma estrutura semelhante à uma matriz, mas com cada coluna sendo tratada separadamente. Em um _Data Frame_, todos osa dados dentro da mesma coluna serão forçados a serem do mesmo tipo. Podemos ver o _Data Frame_ como uma "tabela" formada por um conjunto de dados, podendo ser de tipos diferentes entre as colunas, sendo que esses tipos podem ser variáveis numéricas, _strings_, nominais (fatores), datas etc.

```{r collapse = TRUE}
dados_pessoas.DF = data.frame(peso, idade, altura, renda)
dados_pessoas.DF
```
---
class: center
background-image: url(https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/gif/Exercitar1.gif?raw=true)
background-size: 30%
background-position: 50% 70%

<font color="#256BC1", size="7", face="sans-serif"> <b>Bora trabalhar!</b> </font>

---
# Importando dados no R
.pull-left[
Com o `R`, podemos importar dados de diversos formatos (_xls_, _xlsx_, _CSV_, _txt_, _SAS_, _SPSS_ etc). Devemos seguir os seguintes passos:
1. Saber o caminho do arquivo
1. Usar a função `setwd()` para alterar o diretório de trabalho
1. Instalar o  _tydeverse_, que é um pacote guarda-chuva (conjunto de pacotes) que auxilia no ciclo da ciência de dados (importar, arrumar, transformar, visualizar e modelar)

A sua pasta de trabalho pode ser encontrada com o comando:

```{r collapse = TRUE}
getwd()
```

]

.pull-right[

Para definir a pasta de trabalho, por exemplo, use:



```{r eval=FALSE, echo=TRUE}
setwd("C:/Documentos/Curso R")
```
Atenção: Atente para as barras invertidas ("/") no endereço do arquivo. Ao copiar e colar o endereço, as barras vêem inclinadas para esquerda ("C:\Documentos\Curso R").


Para instalar o `tidyverse`:

```{r eval=FALSE, echo=TRUE}
install.packages("tidyverse")
```

Carregue o `tideverse`

```{r eval=FALSE, echo=TRUE}
library(tidyverse)
```
]

---
## Importando dados no R


O `Tidyverse` agrega um conjunto de 30 pacotes. São eles:

```{r collapse = TRUE}
tidyverse::tidyverse_packages()

```

O pacote `readr` importa arquivos de texto, como `.txt` ou `.csv`.

Já o pacote `readxl` é utilizado para ler planilhas do Excel, basta utilizar a função `read_excel()`.

O pacote `haven` é usado para ler arquivos gerados por outros sotwares, como  `SPSS`, `SAS` e `STATA`.

`r RefManageR::TextCite(referencias, "CursoR")`

---
## Importando dados no R

Mas antes do `tideyverse`, vamos falar um pouco de alguns pacotes de leitura de dados já presentes na instalação básica do `R`. Um desses pacotes é o `utils`, que possui recursos para leitura de diversos arquivos, inclusive aqueles que estão na internet.

Algumas de suas funções são: `read.table` e `read.csv`.

Por padrão, o `R` considera que os dados estão separados por tabulação e o separador de decimais é o ponto.

Se os dados estiverem separados por ":" e o separador decimal for ",", os argumentos `sep` e `dec` da função serão:

```{r eval=FALSE, echo=TRUE}
read.table("dados.csv", head=TRUE, sep=":", dec=",")
```
ou
```{r eval=FALSE, echo=TRUE}
read.csv("dados.csv", head=TRUE, sep=":", dec=",")
```

Ou podemo ler diretamente na internet
```{r eval=FALSE, echo=TRUE}
read.table("https://raw.githubusercontent.com/lcsfilho/Introducao_R/master/Curso%20R/bd/escolas.txt",
           sep="|", dec=",")
```
---
## Importando dados no R

O pacote `foreign`, também presente na distribuição base do `R`, possui diversas funções de importação. Para isso, basta carregar o pacote:


```{r}
library(foreign)
```

Algumas funções para importação de dados no `R`:

.left-column[
- read.dbf()

- read.epiinfo()

- read.mtp()

- read.S()

- read.spss()

- read.dta()

- read.xport()
]


.right-column[

para arquivos DBASE

para arquivos do Epi Info

para arquivos do Minitab

para arquivos do S-Plus

para dados do SPSS

para dados do Stata

para dados do SAS

]

---
## Importando dados no R
Se o arquivo `.sav` está na sua pasta de trabalho:

```{r eval=FALSE}
read.spss("escolas.sav")
```

Caso contrário, localize o arquivo com a função:

```{r eval=FALSE}
file.chose()
```

O `R` retorna o caminho para o arquivo, por exemplo:

```{r eval=FALSE}
"F:\\Curso de R\\Introducao_R\\Curso R\\bd\\escolas.sav"

```

Então, use (com `to.data.frame = TRUE` para retornar um `data frame`)

```{r}
dados.escola = read.spss("F:\\Curso de R\\Introducao_R\\Curso R\\bd\\escolas.sav", to.data.frame = TRUE)
```

Assim, criamos uma variável chamada `dados.escola`, que recebe o banco de banco de dados `escola.sav`

---
## Importando dados no R

Para inspecionar a estrutura do conjunto de dados, use:
```{r include=TRUE}
str(dados.escola)
```
---
## Importando dados no R

Para visualizar todo o conjunto de dados, use:

```{r}
View(dados.escola)
```

Para visualizar as 6 primeiras linhas do conjunto de dados, use:
```{r}
head(dados.escola)
```
---

## Importando dados no R

Vamos importar dados utilizando pacotes do `tidyverse`. Iniciaremos com o pacote `readr`, que importa arquivos de texto, como `.txt` ou `.csv`. O `readr` transforma arquivos de texto em `tibbles`<sup>[1]</sup>, usando as funções:

.left-column[

- read_csv()

- read_csv2()

- read_tsv()

- read_delim()

- read_table()

- read_fwf()

- read_log()

]

.right-column[

lê arquivos delimitados por vírgulas

lê arquivos separados por ponto e vírgula

lê arquivos separados por tabulações

lê arquivos separados por qualquer delimitador

lê arquivos de largura fixa, com colunas separadas por espaço

lê arquivos de largura fixa, onde os campos são especificados por suas larguras

lê arquivos padrões log (estilo `Apache`)

  
<div style="text-align:right"> `r RefManageR::TextCite(referencias, "RDataScience")` </div><br>
]



.footnote[
[1] Tibbles são `data frames` com ajustes em comportamentos antigos, que as deixam mais amigáveis aos cientistas de dados.
]
---
## Importando dados no R

Como exemplo, vamos importar os dados de despesas municipais com educação e saúde, no formato csv. O banco de dados será atribuído ao objeto que chamamos de `desp_csv` 

```{r echo = 2}
library(readr)
desp_csv = read_csv("F:\\Curso de R\\Introducao_R\\Curso R\\bd\\despesas_municipios_saude_educacao.csv")
```
---
## Importando dados no R

Visualize o banco pelo `Console`, executando a variável `desp_csv` ou clique no objeto `desp_csv`, em `Enviroment`, para abrir o banco em outra aba do `R`
```{r}
desp_csv
```
---
## Importando dados no R
Vamos importar um banco de dados em Excel pelo pacote `readxl`. O objeto `dados.escola_xlsx` receberá o banco `escolas.xlsx`:

```{r echo = c(2, 3)}
library(readxl)
dados.escola_xlsx = read_excel("F:\\Curso de R\\Introducao_R\\Curso R\\bd\\escolas.xlsx")
dados.escola_xlsx
```
---
# Carregando dados

Para carregar conjuntos de dados existentes no `R`, use a função `data()`. Vamos carregar os dados `mtcars`, disponível no pacote `datasets`.
O conjunto `mtcars` é um _data frame_ com 32 observações e 11 variáveis numéricas.

.left-column[
- mpg

- cyl

- disp

- hp

- drat 

- wt

- qsec

- vs

- am

- gear

- carb

]
.right-column[
milhas (EUA) por galão

número de cilindros

cilindrada

potência do motor (cavalos de força)

relação do eixo traseiro

peso (1000 libras)

tempo para percorrer 1/4 de milha

motor (0 = V; 1 = reto)

transmisão (0 = automática; 1 = manual)

número de marchas

número de carburadores


]
---
## Carregando dados

Carregue o conjunto de dados com:

```{r}
data(mtcars)
```

Leia as 6 primeiras linhas:

```{r}
head(mtcars)
```

---
# Análise descritiva (unidimensional)

Podemos acessar algumas informações sobre o conjunto de dados `mtcars`com:

```{r eval=FALSE}
help(mtcars)  #Documentação sobre o conjunto de dados

dim(mtcars)   #Dimensão do conjunto de dados

names(mtcars) #Nome das variáveis (colunas)
```

Vamos criar um objeto chamado `carros` e selecionar algumas variáveis do conjunto `mtcars` para compor o novo conjunto


```{r}
carros = mtcars[, c(1, 2, 3, 4, 6, 8, 9, 11)] #Selcionadas as colunas 1, 2, 3, 4, 6, 8, 9 e 11 e todas as observações
head(carros)
```

---
## Análise descritiva (unidimensional)

A função `search()` mostra o caminho de procura do `R`. Quando executada, essa função mostra o `.GlobalEnv`, pacotes, autoloads ou `data frames` e listas adicionadas com a função `attach()`.

Para ver os objetos "atachados", digite:

```{r}
search()
```

Quando precisamos fazer muitas referências para um objeto, é possível minimizar a digitação, colocando o `data frame` ou lista no caminho de procura, pela função attach. 

---
## Análise descritiva (unidimensional)
Perceba que o objeto `carros` não apareceu na lista de objetos "atachados". Se quisermos calcular algumas estatísticas do peso dos carros, usando diretamente a variável `wt`, surgirá uma mensagem de erro:

```{r error=TRUE}
summary(wt)
```

Para executar o sumário sem acrescentar `carros` no caminho de procura, temos que o usar o símbolo `$` entre a base de dados e a coluna (variável) de interesse:

```{r}
summary(carros$wt)
```

---
## Análise descritiva (unidimensional)

"Atachando" a base `carros`, podemos visualizá-la no caminho de procura do `R`.

```{r}
attach(carros)
search()
```

Agora, podemos reduzir a digitação para calcular o sumário da variável peso (`wt`)

```{r}
summary(wt)
```
---
## Análise descritiva (unidimensional)

.pull-left[
Usamos a função `table` para gerar frequências por quantidade de carburador


```{r}
tabela.carb <- table(carb)
tabela.carb
```


Tabela de freqências relativas
```{r}
tabela.carb/length(carb)
```
]

.pull-right[
Ou usando a função `prop.table`
```{r}
prop.table(tabela.carb)
```

]

---
## Análise descritiva (unidimensional)
Tabela de frequências para o peso com intervalos, usando a função `cut`

```{r fig.height=2}

table(cut(wt, br = seq(1.5, 5.5, 0.8)))

```

E outras estatísticas

```{r collapse = TRUE}
median(wt)           #Mediana
mean(wt)             #Média
sd(wt)               #Desvio padrão
sd(wt)/mean(wt)*100  #Coeficiente de variação
```

---
## Análise descritiva (unidimensional)

.pull-left[
Gráfico de setores
```{r fig.height=5.5}
pie(tabela.carb)

```
]

.pull-right[
Gráfico de barras

```{r fig.height=5.5}
barplot(tabela.carb)

```
]

---
## Análise descritiva (unidimensional)


.pull-left[
Histograma
```{r fig.height=5.2}
hist(wt)
```
]

.pull-right[
Boxplot
```{r fig.height=5.2}
boxplot(wt)
```
]
---
## Análise descritiva (unidimensional)

A estética e outros elementos dos gráficos podem ser editados, mas vamos explorar melhor esses recursos com o pacote `ggplot`, que faz parte do `tidyverse`.

```{r fig.height=5.2, fig.align="center"}
hist(wt, col = "blue", border = "yellow", main = "Histograma do peso do veículos",
     xlab = "Peso (1.000 libras)", ylab = "Frequência")
```
---
## Análise descritiva (bidimensional)

número de cilindros (cyl) x número de carburadores (carb)

```{r}
table(cyl, carb)
```

Calculando as proporções:

```{r}
prop.table(table(cyl, carb))
```

---
## Análise descritiva (bidimensional)

Para porcentagens por linha ou por coluna, use `margin = 1` ou `margin = 2`, respectivamente.

```{r}
prop.table(table(cyl, carb), margin = 1)
```

```{r}
prop.table(table(cyl, carb), margin = 2)
```

---
## Análise descritiva (bidimensional)
Também podemos obter visualizações gráficas dos cruzamentos

.pull-left[

```{r fig.height=5.2, fig.align="center"}
plot(table(cyl, carb))
```
]

.pull-right[

```{r fig.height=5.2, fig.align="center"}
barplot(table(cyl, carb), beside = TRUE,
        leg = TRUE)
```


]
---
## Análise descritiva (bidimensional)
Vamos relacionar uma variável categórica (qualitativa) com uma contínua.

Tipo de transmissão (am) x consumo de combustível (mpg)

```{r}
tapply(mpg, am, summary)
```

Usmao `tapply` para dividir o conjunto de dados em grupos.

---
## Análise descritiva (bidimensional)
Construindo um gráfico boxplot da relação `am` x `mpg`.

```{r fig.height=5.5, fig.align="center"}
boxplot(mpg ~ am, col = c("green", "magenta"), names = c("Manual", "Automático"),
        main = "Consumo de combustível por tipo de transmissão", ylab = "milhas por galão")
```

---
## Análise descritiva (bidimensional)


.pull-left[
Vamos verificar o `coeficiente de correlação linear de Pearson` entre o peso (wt) e o conumo de combustível (mpg)
```{r}
cor(wt, mpg)
```
]

.pull-right[
E o `gráfico de dispersão`

```{r fig.height=4.8, fig.align="center"}
plot(wt, mpg, xlab = "Peso do veículo",
     ylab = "Consumo de combustível",
     col = "blue", pch = 19)

```

]
---
## Análise descritiva

Vamos incluir uma terceira variável nesta análise. Os pontos serão identificados pela categoria do número de cilindros (cyl), que são 4, 6 e 8.


```{r eval = FALSE}
plot(wt, mpg, xlab = "Peso do veículo",
     ylab = "Consumo de combustível (milhas/galão)")
points(wt[cyl == 4], mpg[cyl == 4], col="magenta", pch = 19)
points(wt[cyl == 6], mpg[cyl == 6], col="blue", pch = 19)
points(wt[cyl == 8], mpg[cyl == 8], col="green", pch = 19)
legend(4.5, 33, c("4 cilindros", "6 cilindros", "8 cilindros"),
pch = c(19, 19, 19), col=c("magenta", "blue", "green"))
```

---
## Análise descritiva

```{r echo=FALSE, fig.align="center"}
plot(wt, mpg, xlab = "Peso do veículo",
     ylab = "Consumo de combustível (milhas/galão)")
points(wt[cyl == 4], mpg[cyl == 4], col="magenta", pch = 19)
points(wt[cyl == 6], mpg[cyl == 6], col="blue", pch = 19)
points(wt[cyl == 8], mpg[cyl == 8], col="green", pch = 19)
legend(4.5, 33, c("4 cilindros", "6 cilindros", "8 cilindros"),
pch = c(19, 19, 19), col=c("magenta", "blue", "green"))
```

---
# Pacote Tidyverse

Com o pacote `tidyverse`, conseguimos reduzir o tamanho do código para executar uma função. Voltemos ao conjunto de dados das despesas com educação e saúde.

```{r echo = 2, warning=FALSE, message=FALSE}
library(readr)
desp_csv = read_csv("F:\\Curso de R\\Introducao_R\\Curso R\\bd\\despesas_municipios_saude_educacao.csv")
```

Vamos visualizar o banco de dados (`data frame`):

```{r eval = FALSE}
View(desp_csv)
```

E listar os nomes das variáveis:

```{r}
names(desp_csv)
```

---
## Pacote Tidyverse

.pull-left[
Recuperar as despesas dos municípios da Bahia
```{r}
desp_csv[desp_csv$SG_ENTE == "BA", "VALUE"]
```
]

.pull-right[
Somar o total de despesas municipais na Bahia
```{r}
sum(desp_csv[desp_csv$SG_ENTE == "RR",
             "VALUE"])
```

ou da seguinte forma:

```{r}
sum(desp_csv[desp_csv[['SG_ENTE']] == "RR",
             "VALUE"])
```

]

---
## Pacote Tidyverse (dplyer e magrittr)

Vamos fazer a mesma coisa, dessa vez, usando o `dplyr`, um dos pacotes do `Tideverse`. O `dplyer` é muito usado para tarefas de manuseio de dados, como agregar, sumarizar, agrupar, ordenar, filtrar etc.

`r RefManageR::TextCite(referencias, "SillasG")`

```{r}
desp_csv %>%
  dplyr::filter(SG_ENTE == "RR") %>% 
  dplyr::select(VALUE) %>% 
  sum()
```

.pull-left[

Há dois símbolos nesse código: o operador `pipe` (`%>%`) e os quatro pontos (`::`). O `pipe` permite o encademaneto de funções, ele concatena uma sequência de funções. O pacote `magrittr` é responsável pelo operador `pipe`. Já os quatro pontos (`::`) ligam o nome do pacote à sua função.
]

.pull-right[
Ao digitar `::` após o o nome do pacote, o `R` abre uma janela com a lista das funções que pertencem àquele pacote. Além disso, estamos informando ao `R` qual pacote usar para aquela função, pois há funções com o mesmo nome, que pertencem a pacotes diferentes. É também uma forma de documentar o código, deixando claro qual pacote foi usado no código.

]

---
## Pacote Tidyverse (dplyer)

A interpretação do código abaixo está no comentário:
```{r eval=FALSE}
desp_csv %>% #No conjunto de dados "desp_csv"
  dplyr::filter(SG_ENTE == "RR") %>% #Filtre o ente federativo Roraima
  dplyr::select(VALUE) %>% #Selecione a coluna "VALUE"
  sum() #Some tudo
```

Visualize o a despesa total por UF :
```{r eval=FALSE}
desp_csv %>% #No o conjunto de dados "desp_csv"
   dplyr::select(SG_ENTE,VALUE) %>% #Selecione as colunas "SG_ENTE" e "VALUE"
   dplyr::group_by(SG_ENTE) %>% #Agrupe por "SG_ENTE"
   dplyr::summarise(
    Soma = sum(VALUE) #Some os VALUE (valores das despesas)
   )
```

---
## Pacote Tidyverse (dplyer) e pacote rmarkdown

.pull-left[
Visualize o a despesa total por UF :
```{r echo=FALSE}
desp_csv %>% #No o conjunto de dados "desp_csv"
   dplyr::select(SG_ENTE,VALUE) %>% #Selecione as colunas "SG_ENTE" e "VALUE"
   dplyr::group_by(SG_ENTE) %>% #Agrupe por "SG_ENTE"
   dplyr::summarise(
    Soma = sum(VALUE) #Some os VALUE (valores das despesas)
    )

```
]

.pull-right[
Podemos melhorar a visualização da tabela, atribuindo a saída à um objeto, que vamos chamar de `Despesas`. Posteriormente, geramos uma tabela mais formatada com a função `paged_table`, do pacote `rmarkdown`.

```{r include=TRUE}
Despesas <- desp_csv %>%
   dplyr::select(SG_ENTE,VALUE) %>%
   dplyr::group_by(SG_ENTE) %>%
   dplyr::summarise(
    Soma = sum(VALUE)
    )
```
]
---
## Pacote Tidyverse (dplyer)

```{r}
rmarkdown::paged_table(Despesas)
```
---
## Pacote Tidyverse (dplyer) e pacote rmarkdown
 Exibir a despesa total de forma ordenada (do maior para o menor)

```{r include=TRUE, paged.print=FALSE}
Despesas <- desp_csv %>% dplyr::select(SG_ENTE,VALUE) %>% dplyr::group_by(SG_ENTE) %>%
  dplyr::summarise(Soma = sum(VALUE)) %>% dplyr::arrange(dplyr::desc(Soma))
rmarkdown::paged_table(Despesas)
```

---
## Pacote Tidyverse (dplyer)
Salvando os dados em arquivo Excel

```{r}
xlsx::write.xlsx(Despesas, file = "Despesas.xlsx", sheetName = "Despesas", 
  col.names = TRUE, row.names = TRUE, append = FALSE)
```

Vamos preparar uma tabela ordenada pela despesa média per capita, segundo os entes federativos.

```{r}

Desp_Med <- desp_csv %>%
  dplyr::select(NO_ENTE,SG_ENTE,VALUE,QT_HABITANTE) %>% 
  dplyr::group_by(NO_ENTE,SG_ENTE) %>%
  dplyr::summarise(
    DespesaTotal = sum(VALUE),
    PopTotal = mean(QT_HABITANTE))
```
---
## Pacote Tidyverse (dplyer)

```{r}
Desp_Med <- Desp_Med %>% 
   dplyr::group_by(SG_ENTE) %>%
   dplyr::summarise(
    DespesaTotal = sum(DespesaTotal),
    PopTotal = sum(PopTotal)) %>% 
  dplyr::mutate(DespesaMedia = DespesaTotal/PopTotal) %>%
  dplyr::select(SG_ENTE,DespesaMedia) %>%
  dplyr::arrange(dplyr::desc(DespesaMedia))

```



---
## Pacote Tidyverse e Pacote rmarkdown

```{r}
rmarkdown::paged_table(Desp_Med)
```

---
class: center
background-image: url(https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/gif/Exercitar1.gif?raw=true)
background-size: 30%
background-position: 50% 70%

<font color="#256BC1", size="7", face="sans-serif"> <b>Bora trabalhar!</b> </font>

---
## Pacote Tidyverse (ggplot2)

O `ggplot2` é um poderoso pacote para criação de gráficos mais elegantes, versáteis e complexos.

O termo **gg** vem de **gramática de gráficos**. Para um aprofundamento nos fundamentos teóricos do `ggplot2`, é recomendada a leitura de [*A Layered Grammar of Graphics*](http://vita.had.co.nz/papares/layered-grammar.pdf).

O `ggplot2` oferece duas funções principais:
- `quickplot()` ou `qplot`
- `ggplot()`

Iniciemos a construção dos gráficos com a leitura de um banco de dados em txt, com informações de PIB e população.

```{r message=FALSE, warning=FALSE}
dados_PIB = read_delim("F:\\Curso de R\\Introducao_R\\Curso R\\bd\\PIBMunicipios2019.txt",
                       delim = ";")
```
---
## Pacote Tidyverse (ggplot2)
Leitura das primeiras dez linhas do conjunto de dados:
```{r message=FALSE, warning=FALSE}
head(dados_PIB, n = 10)
```
---
## Pacote Tidyverse (ggplot2)

Os gráficos originados em `ggplot2` são baseados em *camadas*. Cada gráfico possui três componentes chave: `data` (os dados que vão alimentar o gráfico); `aes()` (aesthetic mappings), responsável pelo mapeamento estético e as propriedades visuais do gráfico; e a função `geom()`, responsável pela geometria do gráfico (linha, coluna, histograma etc). Vejamos o exemplo de um gráfico de barras do banco `dados_PIB`, que mostra a quantidade de municípios por UF.

```{r message=FALSE, warning=FALSE, fig.align='center', fig.height=3.8}
library(ggplot2)
ggplot(data = dados_PIB, aes(x = UF)) + #aqui temos a definição dos dados e um pouco da estética
  geom_bar() #a geometria definida aqui é o gráfico de barras
```
---
## Pacote Tidyverse (ggplot2)
.pull-left[
```{r message=FALSE, warning=FALSE, fig.align='center', fig.height=5}
ggplot(dados_PIB) +
  geom_bar(aes(y = reorder(UF, UF, length)))
```
]

.pull-right[

Este segundo gráfico apresenta os dados ordenados por quantidade de municípios e na forma de barras horizontais.

Perceba agora que o nome do argumeto `data =` para o conjunto de dados foi suprimido; e a estética está incluída na camada da geometria (`geom_bar()`), e não na primeira camada (`ggplot()`).

]
---
## Pacote Tidyverse (ggplot2)
.pull-left[
```{r eval=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=5}

##Gráfico usando a abordagem tidyverse
library(tidyverse)
dados_PIB %>%
  group_by(UF) %>%
  summarise(
    media = mean(POPULACAO),
    mediana= mean(POPULACAO),
    maximo =  max(POPULACAO),
    minimo = min(POPULACAO),
    total = sum(POPULACAO) #A função sum faz
    #o somatório de um conjunto de valores
    #numéricos
  ) %>%
  ggplot() +
  geom_col(aes(x = UF, y = total))#Experimente
  #trocar o eixo y por outras variáveis
  #descritivas

```

]

.pull-right[
```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=5}

##Gráfico usando a abordagem tidyverse
library(tidyverse)
dados_PIB %>%
  group_by(UF) %>%
  summarise(
    media = mean(POPULACAO),
    mediana= mean(POPULACAO),
    maximo =  max(POPULACAO),
    minimo = min(POPULACAO),
    total = sum(POPULACAO) 
  ) %>%
  ggplot() +
  geom_col(aes(x = UF, y = total))

```
Perceba que o `pipe` concatenou o o código das estatísticas descritivas com o código do gráfico `ggplot`. Por causa dessa "concatenação", a definição do conjunto de dados em `ggplot()` foi suprimida.
]

---
## Pacote Tidyverse (ggplot2)
```{r message=FALSE, warning=FALSE, fig.align='center', fig.height=4}
#Aprofundando  análise e alterando e alterando uma variável
dados_PIB %>%
  dplyr::filter(UF == "BA") %>%
  dplyr::slice_max(order_by = POPULACAO, n = 10) %>%
  dplyr::mutate(MUNICIPIO = reorder(MUNICIPIO, POPULACAO)) %>%
  ggplot()+
  geom_col(aes(y = MUNICIPIO, x = POPULACAO))

```
---
## Pacote Tidyverse (ggplot2 e janitor)

Vamos aumentar a complexidade do código, criando uma nova variável, chamada `PIB_percapita`, a partir da relação entre o PIB total e a população. O `R` apontará um erro nesse código
```{r error=TRUE, fig.align='center', fig.height=5}
dados_PIB %>% 
  dplyr::filter(UF == "BA") %>% 
  dplyr::mutate(PIB_percapita = round(PIB_TOTAL (em R$ mi)/POPULACAO * 1000, 0)) %>%
  dplyr::select(MUNICIPIO, PIB_percapita) %>% 
  dplyr::arrange(dplyr::desc(PIB_percapita)) %>% 
  ggplot()+
  geom_col(aes(y = MUNICIPIO, x = POPULACAO))
```
O problema econtra-se no texto da variável `PIB_TOTAL (em R$ mi)`, pois o símbolo `$` é utilizado pelo `R` para referenciar colunas de um banco de dados. Teremos outro problema se `PIB_TOTAL (em R$ mi)` for colocado entre aspas. Vamos testar:

---
## Pacote Tidyverse (ggplot2 e janitor)

Vamos aumentar a complexidade do código, criando uma nova variável, chamada `PIB_percapita`, a partir da relação entre o PIB total e a população. O `R` apontará um erro nesse código
```{r error=TRUE, fig.align='center', fig.height=5}
dados_PIB %>% 
  dplyr::filter(UF == "BA") %>% 
  dplyr::mutate(PIB_percapita = round("PIB_TOTAL (em R$ mi)"/POPULACAO * 1000, 0)) %>%
  dplyr::select(MUNICIPIO, PIB_percapita) %>% 
  dplyr::arrange(dplyr::desc(PIB_percapita)) %>% 
  ggplot()+
  geom_col(aes(y = MUNICIPIO, x = POPULACAO))
```

Nesse caso, introduzir as aspas fez a função `mutate` "entender" que a variável `PIB_TOTAL (em R$ mi)` é um argumento não-numérico. É aí que entra o pacote `janitor`, que vai arrumar os nomes das variáveis para atender às boas práticas de programação, removendo o espaço em branco no nome de cada variável.

---
## Pacote Tidyverse (ggplot2 e janitor)

Vamos listar as variáveis presentes na base de dados com a função `names()`:
```{r}
dados_PIB %>% names()
```
Os nomes de algumas variáveis contém espaços, que atrapalham na hora da programação. A função `clean_names()` do pacote `janitor` faz a limpeza de acentos, letras maiúsculas, parênteses, pontos, barras etc, que causam problemas na leitura das variáveis. Veja como ficam as variáveis após a limpeza:

```{r}
dados_PIB %>% #A partir a base dados_PIB
  janitor::clean_names() %>% #Limpe os nomes das variáveis
  names() #Liste os nomes das variáveis 
```

---
## Pacote Tidyverse (ggplot2 e janitor)
Só que o código anterior não fez a substitituição das variáveis, mas fez apenas uma limpeza nos nomes sem modificar a estrutura do banco. Para realizar essa alteração, vamos substituir o banco `dados_PIB` por outro do mesmo nome, com a substituição dos nomes das variáveis.

```{r message=FALSE, warning=FALSE}
library(janitor)
dados_PIB <-  clean_names(dados_PIB) #Limpe os nomes das variáveis e substitua o banco antigo

names(dados_PIB) #Liste os nomes das variáveis
```

Agora, sim, podemos gerar aquele gráfico com o `ggplot2`, fazendo as devidas substituições.

---
## Pacote Tidyverse (ggplot2)
.pull-left[
```{r eval=FALSE, fig.align='center', fig.height=4.5}
dados_PIB %>% 
  dplyr::filter(uf == "RO") %>% 
  dplyr::mutate(pib_percapita =
                round(
                  pib_total_em_r_mi/populacao
                  * 1000, 0)) %>%
  dplyr::select(municipio,
                pib_percapita) %>% 
  dplyr::mutate(municipio =
                  reorder(municipio,
                          pib_percapita)) %>% 
  ggplot()+
  geom_col(aes(y = municipio,
               x = pib_percapita))
```
]

.pull-right[
```{r echo=FALSE, fig.align='center', fig.height=6.5}
dados_PIB %>% 
  dplyr::filter(uf == "RO") %>% 
  dplyr::mutate(pib_percapita = round(pib_total_em_r_mi/populacao * 1000, 0)) %>%
  dplyr::select(municipio, pib_percapita) %>% 
  dplyr::mutate(municipio = reorder(municipio, pib_percapita)) %>% 
  ggplot()+
  geom_col(aes(y = municipio, x = pib_percapita))
```
]


---
## Pacote Tidyverse (ggplot2)


```{r eval=FALSE, fig.align='center', fig.height=7}
dados_PIB %>% #Na base de dados "dados_PIB"
  group_by(uf) %>% #Agrupe por "uf"
  summarise(PIBtotal = round(sum(pib_total_em_r_mi)/1000000,1)) %>% #crie a variavel "PIBtotal",
  #somando a coluna do pib, divida por 1 milhao e arredonde para 1 decimal
  ggplot() + #crie um gráfico "ggplot"
  ggplot2::aes( y = forcats::fct_reorder(uf,PIBtotal), #no eixo Y, ordene as UFs pelo PIB
    x = PIBtotal) + #no eixo x, o PIB
  ggplot2::geom_col(fill = 'deeppink', width = 0.9, alpha = 0.7, colour = 'blue') + #use gráfico de
  #coluna de cor rosa profunda, largura 0.9, transparencia 0.7 e boradas azuis
  ggplot2::labs(x = 'PIB total (em R$ BI)',  y = 'Unidade Federativa', #Substitua os textos nos eixos x e y
    title = 'Produto interno bruto segundo unidade federativa. 2019. Brasil', #Acrescente um título
    subtitle = 'Dados consultados em 14/12/2022', #Acrescente o subtítulo
    caption = 'Fonte: IBGE') + #Acrescente a fonte
  theme_test() + #use esse o tema "theme_test()" (sem cor no fundo e sem linhas intermediárias)
   geom_text(aes(label = PIBtotal), vjust = 0.4, hjust = -0.06) + # rótulos na variável PIBtotal
  #no argumento "theme", faça os seguintes ajustes de altura (size) e cor (colour):
  theme(axis.text.x = element_text(size = 14, colour = 'blue'), #altura 14 e cor azul para o texto do eixo y
    axis.text.y = element_text(size = 12, colour = 'blue'), #texto do eixo y
    axis.title.y = element_text(size = 12, colour = 'blue'), #título do eixo y
    axis.title.x = element_text(size = 14, colour = 'blue'), #título do eixo x
    plot.title = element_text(size = 20)) #título principal
```

---
## Pacote Tidyverse (ggplot2)

```{r echo=FALSE, fig.align='center', fig.height=6.8, fig.width=12}

dados_PIB %>%
  group_by(uf) %>%
  summarise(PIBtotal = round(sum(pib_total_em_r_mi)/1000000,1)) %>%
  ggplot() +
  ggplot2::aes( y = forcats::fct_reorder(uf,PIBtotal), 
    x = PIBtotal) +
  ggplot2::geom_col(fill = 'deeppink', width = 0.9, alpha = 0.7, colour = 'blue') +
  ggplot2::labs(x = 'PIB total (em R$ BI)',  y = 'Unidade Federativa',
    title = 'Produto interno bruto segundo unidade federativa. 2019. Brasil',
    subtitle = 'Dados consultados em 14/12/2022',
    caption = 'Fonte: IBGE') +
  theme_test() +
   geom_text(aes(label = PIBtotal), vjust = 0.4, hjust = -0.06) + 
  theme(axis.text.x = element_text(size = 14, colour = 'blue'),
    axis.text.y = element_text(size = 12, colour = 'blue'),
    axis.title.y = element_text(size = 12, colour = 'blue'),
    axis.title.x = element_text(size = 14, colour = 'blue'),
    plot.title = element_text(size = 20))
```
---
## Pacote Tidyverse (ggplot2)

Histograma do PIB per capita municipal no estado da Bahia

```{r eval=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6.8, fig.width=12}

dados_PIB %>%
  filter(uf == "BA") %>% 
  dplyr::mutate(pib_percapita = round(pib_total_em_r_mi/populacao * 1000, 0)) %>%
  ggplot() +
    geom_histogram(aes(x = pib_percapita), fill = "blue", color = "#000050",) +
  theme_bw() +
  ggtitle('Histograma do PIB per capita municipal. Bahia. 2019') +
  xlab("PIB per capita") +
  ylab("Quantidade de municípios")


```
---
## Pacote Tidyverse (ggplot2)

Histograma em escala contínua no eixo y

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}
dados_PIB %>%
  filter(uf == "BA") %>% 
  dplyr::mutate(pib_percapita = round(pib_total_em_r_mi/populacao * 1000, 0)) %>%
  ggplot() +
    geom_histogram(aes(x = pib_percapita), fill = "blue", color = "#000050",) +
  theme_bw() +
  ggtitle('Histograma do PIB per capita municipal. Bahia. 2019') +
  xlab("PIB per capita") +
  ylab("Quantidade de municípios")

```

---
## Pacote Tidyverse (ggplot2)

Histograma em **escala logarítmica** no eixo y

```{r eval=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}
dados_PIB %>%
  filter(uf == "BA") %>% 
  dplyr::mutate(pib_percapita = round(pib_total_em_r_mi/populacao * 1000, 0)) %>%
  ggplot() +
    geom_histogram(aes(x = pib_percapita), fill = "blue", color = "#000050",) +
  theme_bw() +
  ggtitle('Histograma do PIB per capita municipal. Bahia. 2019') +
  xlab("PIB per capita") +
  ylab("Quantidade de municípios (escala logarítmica)") +
  scale_y_log10() #transformação logarítmica no eixo (y)

```
---
## Pacote Tidyverse (ggplot2)

Histograma em **escala logarítmica** no eixo y

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}
dados_PIB %>%
  filter(uf == "BA") %>% 
  dplyr::mutate(pib_percapita = round(pib_total_em_r_mi/populacao * 1000, 0)) %>%
  ggplot() +
    geom_histogram(aes(x = pib_percapita), fill = "blue", color = "#000050",) +
  theme_bw() +
  ggtitle('Histograma do PIB per capita municipal. Bahia. 2019') +
  xlab("PIB per capita") +
  ylab("Quantidade de municípios (escala logarítmica)") +
  scale_y_log10() #transformação logarítmica no eixo (y)

```

---
## Pacote Tidyverse (ggplot2)

Box-plot do PIB per capita na Bahia em escala contínua.

```{r eval=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}
dados_PIB %>%
  filter(uf == "BA") %>% 
  dplyr::mutate(pib_percapita = round(pib_total_em_r_mi/populacao * 1000, 0)) %>%
  ggplot() +
    geom_boxplot(aes(x = pib_percapita), fill = "blue", color = "#000050",) +
  theme_classic() +
  ggtitle('Box-plot do PIB per capita municipal na Bahia. 2019') +
  xlab("PIB per capita")

```

---
## Pacote Tidyverse (ggplot2)


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}
dados_PIB %>%
  filter(uf == "BA") %>% 
  dplyr::mutate(pib_percapita = round(pib_total_em_r_mi/populacao * 1000, 0)) %>%
  ggplot() +
    geom_boxplot(aes(x = pib_percapita), fill = "blue", color = "#000050",) +
  theme_classic() +
  ggtitle('Box-plot do PIB per capita municipal na Bahia. 2019') +
  xlab("PIB per capita")

```

---
## Pacote Tidyverse (ggplot2)

Box-plot do PIB per capita na Bahia em escala logarítmica

```{r eval=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}
dados_PIB %>%
  filter(uf == "BA") %>% 
  dplyr::mutate(pib_percapita = round(pib_total_em_r_mi/populacao * 1000, 0)) %>%
  ggplot() +
    geom_boxplot(aes(x = pib_percapita), fill = "blue", color = "#000050",) +
  theme_classic() +
  ggtitle('Box-plot do PIB per capita municipal na Bahia. 2019') +
  xlab("PIB per capita") +
  scale_x_log10() #transformação logarítmica no eixo (x)

```

---
## Pacote Tidyverse (ggplot2)

**Escala logarítmica** no eixo x

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}
dados_PIB %>%
  filter(uf == "BA") %>% 
  dplyr::mutate(pib_percapita = round(pib_total_em_r_mi/populacao * 1000, 0)) %>%
  ggplot() +
    geom_boxplot(aes(x = pib_percapita), fill = "blue", color = "#000050",) +
  theme_classic() +
  ggtitle('Box-plot do PIB per capita municipal na Bahia. 2019') +
  xlab("PIB per capita (escala logarítmica)") +
  scale_x_log10() #transformação logarítimica no eixo (x)

```

---
## Pacote Tidyverse (ggplot2)

Uma maneira de introduzir o nome do município no ponto mais distante (outlier) é usando o código a seguir:

```{r eval=TRUE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}

dado <- dados_PIB %>% #Atribuir ao objeto "dado" o banco "dados_PIB"
  dplyr::mutate(pib_percapita = round(pib_total_em_r_mi/populacao * 1000, 0)) %>% #Criar a variável 
  #PIB per capita
  filter(uf == "BA", pib_percapita > 200000) #filtrar o estado da Bahia e o PIB per capita maior
  #que 200.000
dado #Visualizar o objeto "dado"
```

O município de interesse é São Francisco do Conde, com valor de PIB per capita de 217.464.

Agora, vamos introduzir  o *label* de São Francisco do Conde com a função **anotatte**.

---
## Pacote Tidyverse (ggplot2)
```{r eval=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}
dados_PIB %>%
  filter(uf == "BA") %>% 
  dplyr::mutate(pib_percapita = round(pib_total_em_r_mi/populacao * 1000, 0)) %>%
  ggplot() +
  geom_boxplot(aes(x = pib_percapita), fill = "blue", color = "#000050") +
  theme_classic() +
  ggtitle('Box-plot do PIB per capita municipal na Bahia. 2019') +
  xlab("PIB per capita (escala logarítmica)") +
  annotate("text", x = 217464, y = 0.05, label = "São Francisco \n do Conde") #O argumento "text"
#\n quebra a linha
#é uma das geometrias da função
#x e y dão as coordedanas do label
```


---
## Pacote Tidyverse (ggplot2)
```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}
dados_PIB %>%
  filter(uf == "BA") %>% 
  dplyr::mutate(pib_percapita = round(pib_total_em_r_mi/populacao * 1000, 0)) %>%
  ggplot() +
  geom_boxplot(aes(x = pib_percapita), fill = "blue", color = "#000050") +
  theme_classic() +
  ggtitle('Box-plot do PIB per capita municipal na Bahia. 2019') +
  xlab("PIB per capita (escala logarítmica)") +
  annotate("text", x = 217464, y = 0.05, label = "São Francisco \n do Conde") #O argumento "text"
#\n quebra a linha
#é uma das geometrias da função
#x e y dão as coordedanas do label
```

---
## Pacote Tidyverse (ggplot2)

Box-plot do PIB per capita por UF em **escala contínua**

```{r eval=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}
dados_PIB %>%
  group_by(uf) %>% 
  dplyr::mutate(pib_percapita = round(pib_total_em_r_mi/populacao * 1000, 0)) %>%
  ggplot() +
  geom_boxplot(aes(x = uf, y = pib_percapita, fill = uf)) +
    theme_classic() +
  ggplot2::labs(
  title = 'Distribuição do PIB per capita municipal por UF. Brasil. 2019',
  x = "UF",
  y = "PIB per capita") +
  theme(legend.position="none")
```
---
## Pacote Tidyverse (ggplot2)

Box-plot do PIB per capita por UF em **escala contínua**

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}
dados_PIB %>%
  group_by(uf) %>% 
  dplyr::mutate(pib_percapita = round(pib_total_em_r_mi/populacao * 1000, 0)) %>%
  ggplot() +
  geom_boxplot(aes(x = uf, y = pib_percapita, fill = uf)) +
    theme_classic() +
  ggplot2::labs(
  title = 'Distribuição do PIB per capita municipal por UF. Brasil. 2019',
  x = "UF",
  y = "PIB per capita") +
   theme(legend.position="none")
```

---

## Pacote Tidyverse (ggplot2)

Box-plot do PIB per capita por UF em **escala logarítmica**

```{r eval=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}
dados_PIB %>%
  group_by(uf) %>% 
  dplyr::mutate(pib_percapita = round(pib_total_em_r_mi/populacao * 1000, 0)) %>%
  ggplot() +
  geom_boxplot(aes(x = uf, y = pib_percapita, fill = uf)) +
    theme_classic() +
  ggplot2::labs(
  title = 'Distribuição do PIB per capita municipal por UF. Brasil. 2019',
  x = "UF",
  y = "PIB per capita") +
  theme(legend.position="none") +
  scale_y_log10()
```
---
## Pacote Tidyverse (ggplot2)

Box-plot do PIB per capita por UF em **escala logarítmica**

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}
dados_PIB %>%
  group_by(uf) %>% 
  dplyr::mutate(pib_percapita = round(pib_total_em_r_mi/populacao * 1000, 0)) %>%
  ggplot() +
  geom_boxplot(aes(x = uf, y = pib_percapita, fill = uf)) +
    theme_classic() +
  ggplot2::labs(
  title = 'Distribuição do PIB per capita municipal por UF. Brasil. 2019',
  x = "UF",
  y = "PIB per capita") +
   theme(legend.position="none") +
  scale_y_log10()
```

---
## Pacote Tidyverse (ggplot2)

Ranking dos 10 municípios baianos com maior PIB per capita


```{r eval=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}
dados_PIB %>%
  filter(uf == "BA") %>%
  group_by(municipio) %>%
  summarise(
  pib_percapita = round(pib_total_em_r_mi/populacao * 1000, 0)
  ) %>%
  slice_max(order_by = pib_percapita, n = 10) %>%
  mutate(municipio=reorder(municipio,pib_percapita)) %>%
  ggplot() +
  geom_col(aes(y=municipio, x = pib_percapita), fill = "Blue")+
  theme_classic() +
  ggplot2::labs(
  title = 'Ranking dos 10 municípios baianos com maior PIB per capita. 2019',
  x = "PIB per capita",
  y = "Municípios")
names(dados_PIB)
  
```
---
## Pacote Tidyverse (ggplot2)

Ranking dos 10 municípios baianos com maior PIB per capita


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}
dados_PIB %>%
  filter(uf == "BA") %>%
  group_by(municipio) %>%
  summarise(
  pib_percapita = round(pib_total_em_r_mi/populacao * 1000, 0)
  ) %>%
  slice_max(order_by = pib_percapita, n = 10) %>%
  mutate(municipio=reorder(municipio,pib_percapita)) %>%
  ggplot() +
  geom_col(aes(y=municipio, x = pib_percapita), fill = "Blue")+
  theme_classic() +
  ggplot2::labs(
  title = 'Ranking dos 10 municípios baianos com maior PIB per capita. 2019',
  x = "PIB per capita",
  y = "Municípios")
names(dados_PIB)
  
```

---
## Pacote Tidyverse (ggplot2)

Vamos importar uma série histórica do DataSUS de 2000 a 2020, sobre nascimento e óbitos infantis por UF.

```{r message=FALSE, warning=FALSE}
library(readxl)
dados_saude <- read_xlsx("F:/Curso de R/Introducao_R/Curso R/bd/dados_saude.xlsx")
head(dados_saude)
```

---
## Pacote Tidyverse (ggplot2)

**Gráfico de dispersão**, relacionando a taxa de mortalidade infantil e taxa de doenças infecciosas e parasitárias

```{r eval=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}
dados_saude %>% 
  dplyr::mutate(
    tx_mort_inf = round(obitos_infantis / nascidos_vivos * 1000, 1),
    tx_doencas_infecciosas = round(doencas_infecciosas / populacao *100000,1)
    ) %>% 
  ggplot() +
  geom_point(aes(x = tx_mort_inf, y = tx_doencas_infecciosas)) +
  theme_classic() +
  ggplot2::labs(
  title = 'Gráfico de dispersão entre a taxa de mortalidade infantil e taxa de doenças infecciosas e parasitárias',
  x = "Taxa de mortalidade infantil (por 1000 n.v.)",
  y = "Taxa de incidência de doenças infecciosas e parasitárias (por 100 mil hab.")
```


---
## Pacote Tidyverse (ggplot2)


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6.5, fig.width=12}
dados_saude %>% 
  dplyr::mutate(
    tx_mort_inf = round(obitos_infantis / nascidos_vivos * 1000, 1),
    tx_doencas_infecciosas = round(doencas_infecciosas / populacao *100000,1)
    ) %>% 
  ggplot() +
  geom_point(aes(x = tx_mort_inf, y = tx_doencas_infecciosas), color = "blue", size = 2) +
  theme_classic() +
  ggplot2::labs(
  title = 'Gráfico de dispersão entre a taxa de mortalidade infantil e taxa de doenças infecciosas e parasitárias',
  x = "Taxa de mortalidade infantil (por 1000 n.v.)",
  y = "Taxa de incidência de doenças infecciosas e parasitárias (por 100 mil hab.")
```

---
## Pacote Tidyverse (ggplot2)

**Incluindo linha de tendência**

```{r eval=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6.5, fig.width=12}
dados_saude %>% 
  dplyr::mutate(
    tx_mort_inf = round(obitos_infantis / nascidos_vivos * 1000, 1),
    tx_doencas_infecciosas = round(doencas_infecciosas / populacao *100000,1)
    ) %>% 
  ggplot() +
  geom_point(aes(x = tx_mort_inf, y = tx_doencas_infecciosas), color = "blue", size = 2) +
  #geom-smooth inclui a linha de tendência;
  #o método "lm" é tendencia linear
  geom_smooth(aes(x = tx_mort_inf, y = tx_doencas_infecciosas), method = 'lm') +
  theme_classic() +
  ggplot2::labs(
  title = 'Gráfico de dispersão entre a taxa de mortalidade infantil e taxa de doenças infecciosas e parasitárias',
  x = "Taxa de mortalidade infantil (por 1000 n.v.)",
  y = "Taxa de incidência de doenças infecciosas e parasitárias (por 100 mil hab."
  )
```
---
## Pacote Tidyverse (ggplot2)


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6.5, fig.width=12}
dados_saude %>% 
  dplyr::mutate(
    tx_mort_inf = round(obitos_infantis / nascidos_vivos * 1000, 1),
    tx_doencas_infecciosas = round(doencas_infecciosas / populacao *100000,1)
    ) %>% 
  ggplot() +
  geom_point(aes(x = tx_mort_inf, y = tx_doencas_infecciosas), color = "blue", size = 2) +
  #geom-smooth inclui a linha de tendência;
  #o método "lm" é tendencia linear
  geom_smooth(aes(x = tx_mort_inf, y = tx_doencas_infecciosas), method = 'lm') +
  theme_classic() +
  ggplot2::labs(
  title = 'Gráfico de dispersão entre a taxa de mortalidade infantil e taxa de doenças infecciosas e parasitárias',
  x = "Taxa de mortalidade infantil (por 1000 n.v.)",
  y = "Taxa de incidência de doenças infecciosas e parasitárias (por 100 mil hab."
  )
```
---
## Pacote Tidyverse (ggplot2)

**Incluindo linha de tendência**

```{r eval=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6.5, fig.width=12}
dados_saude %>% 
  dplyr::mutate(
    tx_mort_inf = round(obitos_infantis / nascidos_vivos * 1000, 1),
    tx_doencas_infecciosas = round(doencas_infecciosas / populacao *100000,1)
    ) %>% 
  ggplot() +
  geom_point(aes(x = tx_mort_inf, y = tx_doencas_infecciosas, color = uf),  size = 2) + #Para diferenciar por UF, incluímos a cor dentro de "aes"
  #geom-smooth inclui a linha de tendência;
  #o método "lm" é tendencia linear
  geom_smooth(aes(x = tx_mort_inf, y = tx_doencas_infecciosas), method = 'lm') +
  theme_classic() +
  ggplot2::labs(
  title = 'Gráfico de dispersão entre a taxa de mortalidade infantil e taxa de doenças infecciosas e parasitárias',
  x = "Taxa de mortalidade infantil (por 1000 n.v.)",
  y = "Taxa de incidência de doenças infecciosas e parasitárias (por 100 mil hab.",
  color = "Unidade federativa"
  )
```



---
## Pacote Tidyverse (ggplot2)


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6.5, fig.width=12}
dados_saude %>% 
  dplyr::mutate(
    tx_mort_inf = round(obitos_infantis / nascidos_vivos * 1000, 1),
    tx_doencas_infecciosas = round(doencas_infecciosas / populacao *100000,1)
    ) %>% 
  ggplot() +
  geom_point(aes(x = tx_mort_inf, y = tx_doencas_infecciosas, color = uf),  size = 2) + #Para diferenciar por UF, incluímos a cor dentro de "aes"
  #geom-smooth inclui a linha de tendência;
  #o método "lm" é tendencia linear
  geom_smooth(aes(x = tx_mort_inf, y = tx_doencas_infecciosas), method = 'lm') +
  theme_classic() +
  ggplot2::labs(
  title = 'Gráfico de dispersão entre a taxa de mortalidade infantil e taxa de doenças infecciosas e parasitárias',
  x = "Taxa de mortalidade infantil (por 1000 n.v.)",
  y = "Taxa de incidência de doenças infecciosas e parasitárias (por 100 mil hab.",
  color = "Unidade federativa"
  )
```

---
## Pacote Tidyverse (ggplot2)
**Introduzindo a coluna de Regiões**

Primeiro, vamos importar o arquivo "regioes.csv", que está no repositório do `GitHub`

```{r Nao_executar_nem_exibir_codigo, eval=FALSE, include=FALSE}
dados_saude <- dados_saude %>% 
  dplyr::mutate ( cod_regiao = dplyr::case_when(cod_uf < 20 ~ 1,
                                            cod_uf < 30 ~ 2,
                                            cod_uf < 40 ~ 3,
                                            cod_uf < 50 ~ 4,
                                            cod_uf < 60 ~ 5),
                  dec_regiao = dplyr::case_when(cod_uf < 20 ~ "Norte",
                                            cod_uf < 30 ~ "Nordeste",
                                            cod_uf < 40 ~ "Sudeste",
                                            cod_uf < 50 ~ "Sul",
                                            cod_uf < 60 ~ "Centro-Oeste"))

```

```{r}

regioes <- utils::read.csv(
  file = 'https://raw.githubusercontent.com/lcsfilho/Introducao_R/master/Curso%20R/bd/regioes.csv',
  sep = ';',
  dec = ','
)
head(regioes)
```

---
## Pacote Tidyverse (ggplot2)
**Introduzindo a coluna de Regiões**
Agora, vamos juntar os conjuntos `dados_saude` e `regioes` com a função `lefht_join`. É algo parecido com a função `PROCV` do `Excel`.

```{r }
#Juntando os datasets "dados_saude" com "regioes"
dados_saude <- dplyr::left_join( #Chamamos a função `left_jpoin`, substituindo o conjunto
  #"dados_saude"
  x = dados_saude, #à esquerda, o conjunto "dados_saude"
  y = regioes, #à direita, o conjunto "regioes"
  by = c('cod_uf'='cod_uf') #a união é pelo código das UFs.
  #Esquerda: cod_uf do conjunto "dados_saude". 
  #Direita: cod_uf do conjunto "regioes"
  #Obs: as colunas não precisam ter necessariamente o mesmo nome
)
names(dados_saude) #relacionando os nomes das colunas

```

---
## Pacote Tidyverse (ggplot2)

**Gráfico de dispersão diferenciando as regiões**

```{r eval=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6.5, fig.width=12}
dados_saude %>% 
  dplyr::mutate(
    tx_mort_inf = round(obitos_infantis / nascidos_vivos * 1000, 1),
    tx_doencas_infecciosas = round(doencas_infecciosas / populacao *100000,1)
    ) %>% 
  ggplot() +
   #Diferenciar por Regiao
  #geom-smooth inclui a linha de tendência;
  #o método "lm" é tendencia linear
  geom_point(aes(x = tx_mort_inf, y = tx_doencas_infecciosas, color = desc_regiao),  size = 2) +
  geom_smooth(aes(x = tx_mort_inf, y = tx_doencas_infecciosas), method = 'lm') +
  theme_classic() +
  ggplot2::labs(
  title = 'Gráfico de dispersão entre a taxa de mortalidade infantil e taxa de doenças infecciosas e parasitárias',
  x = "Taxa de mortalidade infantil (por 1000 n.v.)",
  y = "Taxa de incidência de doenças infecciosas e parasitárias (por 100 mil hab.",
  color = "Região") + 
  scale_colour_manual(values = c('#078F34','blue','red','orange','#A601E8')) #personalizando as cores
```


---
## Pacote Tidyverse (ggplot2)


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6.5, fig.width=12}
dados_saude %>% 
  dplyr::mutate(
    tx_mort_inf = round(obitos_infantis / nascidos_vivos * 1000, 1),
    tx_doencas_infecciosas = round(doencas_infecciosas / populacao *100000,1)
    ) %>% 
  ggplot() +
  #Diferenciar por Regiao
  #geom-smooth inclui a linha de tendência;
  #o método "lm" é tendencia linear
  geom_point(aes(x = tx_mort_inf, y = tx_doencas_infecciosas, color = desc_regiao),  size = 2) +
  geom_smooth(aes(x = tx_mort_inf, y = tx_doencas_infecciosas), method = 'lm') +
  theme_classic() +
  ggplot2::labs(
  title = 'Gráfico de dispersão entre a taxa de mortalidade infantil e taxa de doenças infecciosas e parasitárias',
  x = "Taxa de mortalidade infantil (por 1000 n.v.)",
  y = "Taxa de incidência de doenças infecciosas e parasitárias (por 100 mil hab.",
  color = "Região") + 
  scale_colour_manual(values = c('#078F34','blue','red','orange','#A601E8')) #personalizando as cores
```

---
## Pacote Tidyverse (ggplot2)

**Gráfico de dispersão agrupando por ano e região**

```{r eval=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6.5, fig.width=12}
dados_saude %>% 
  group_by(ano, desc_regiao) %>% #agrupando por ano e região
  dplyr::mutate(
    tx_mort_inf = round(sum(obitos_infantis) / sum(nascidos_vivos) * 1000, 1), #Esse agrupamento exige o somatório das variáveis
    tx_doencas_infecciosas = round(sum(doencas_infecciosas) / sum(populacao) *100000,1) #Esse agrupamento exige o somatório das variáveis
    ) %>% 
  ggplot() +
  geom_point(aes(x = tx_mort_inf, y = tx_doencas_infecciosas, color = desc_regiao),  size = 2) + #Diferenciar por Regiao
  #geom-smooth inclui a linha de tendência;
  #o método "lm" é tendencia linear
  geom_smooth(aes(x = tx_mort_inf, y = tx_doencas_infecciosas), method = 'lm') +
  theme_classic() +
  ggplot2::labs(
  title = 'Gráfico de dispersão entre a taxa de mortalidade infantil e taxa de doenças infecciosas e parasitárias',
  x = "Taxa de mortalidade infantil (por 1000 n.v.)",
  y = "Taxa de incidência de doenças infecciosas e parasitárias (por 100 mil hab.",
  color = "Região"
  ) + 
  scale_colour_manual(values = c('#078F34','blue','red','orange','#A601E8')) #personalizando as cores
```
---
## Pacote Tidyverse (ggplot2)


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6.5, fig.width=12}
dados_saude %>% 
  group_by(ano, desc_regiao) %>% #agrupando por ano e região
  dplyr::mutate(
    tx_mort_inf = round(sum(obitos_infantis) / sum(nascidos_vivos) * 1000, 1), #Esse agrupamento exige o somatório das variáveis
    tx_doencas_infecciosas = round(sum(doencas_infecciosas) / sum(populacao) *100000,1) #Esse agrupamento exige o somatório das variáveis
    ) %>% 
  ggplot() +
  geom_point(aes(x = tx_mort_inf, y = tx_doencas_infecciosas, color = desc_regiao),  size = 2) + #Diferenciar por Regiao
  #geom-smooth inclui a linha de tendência;
  #o método "lm" é tendencia linear
  geom_smooth(aes(x = tx_mort_inf, y = tx_doencas_infecciosas), method = 'lm') +
  theme_classic() +
  ggplot2::labs(
  title = 'Gráfico de dispersão entre a taxa de mortalidade infantil e taxa de doenças infecciosas e parasitárias',
  x = "Taxa de mortalidade infantil (por 1000 n.v.)",
  y = "Taxa de incidência de doenças infecciosas e parasitárias (por 100 mil hab.",
  color = "Região"
  ) + 
  scale_colour_manual(values = c('#078F34','blue','red','orange','#A601E8')) #personalizando as cores
```

---
## Pacote Tidyverse (ggplot2)

**Facetando gráficos**

```{r eval=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}
dados_saude %>%
  group_by(desc_regiao) %>%
  dplyr::mutate(
    tx_mort_inf = round(obitos_infantis / nascidos_vivos * 1000, 1),
    tx_doencas_infecciosas = round(doencas_infecciosas / populacao *100000,1)
    ) %>% 
  ggplot() +
  geom_point(aes(x = tx_mort_inf, y = tx_doencas_infecciosas, color = desc_regiao)) +
  ggplot2::labs(
  title = 'Gráfico de dispersão entre a taxa de mortalidade infantil e taxa de doenças infecciosas e parasitárias',
  x = "Taxa de mortalidade infantil (por 1000 n.v.)",
  y = "Taxa de incidência de doenças infecciosas e parasitárias (por 100 mil hab.",
  color = "Região") + 
  facet_grid(~ desc_regiao) #Facetando por Região
```


---
## Pacote Tidyverse (ggplot2)


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6.5, fig.width=12}
dados_saude %>%
  group_by(desc_regiao) %>%
  dplyr::mutate(
    tx_mort_inf = round(obitos_infantis / nascidos_vivos * 1000, 1),
    tx_doencas_infecciosas = round(doencas_infecciosas / populacao *100000,1)
    ) %>% 
  ggplot() +
  geom_point(aes(x = tx_mort_inf, y = tx_doencas_infecciosas, color = desc_regiao)) +
  ggplot2::labs(
  title = 'Gráfico de dispersão entre a taxa de mortalidade infantil e taxa de doenças infecciosas e parasitárias',
  x = "Taxa de mortalidade infantil (por 1000 n.v.)",
  y = "Taxa de incidência de doenças infecciosas e parasitárias (por 100 mil hab.",
  color = "Região") + 
  facet_grid(~ desc_regiao) #Facetando por Região
```

---
## Pacote Tidyverse (ggplot2)

**Facetando gráficos**

```{r eval=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}
dados_saude %>%
  group_by(desc_regiao) %>%
  dplyr::mutate(
    tx_mort_inf = round(obitos_infantis / nascidos_vivos * 1000, 1),
    tx_doencas_infecciosas = round(doencas_infecciosas / populacao *100000,1)
    ) %>% 
  ggplot() +
  geom_point(aes(x = tx_mort_inf, y = tx_doencas_infecciosas, color = desc_regiao)) +
  ggplot2::labs(
  title = 'Gráfico de dispersão entre a taxa de mortalidade infantil e taxa de doenças infecciosas e parasitárias',
  x = "Taxa de mortalidade infantil (por 1000 n.v.)",
  y = "Taxa de incidência de doenças infecciosas e parasitárias (por 100 mil hab.",
  color = "Região") + 
  facet_grid(vars(desc_regiao),vars(ano)) #Facetando por Região e ano
```


---
## Pacote Tidyverse (ggplot2)


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6.5, fig.width=12}
dados_saude %>%
  group_by(desc_regiao) %>%
  dplyr::mutate(
    tx_mort_inf = round(obitos_infantis / nascidos_vivos * 1000, 1),
    tx_doencas_infecciosas = round(doencas_infecciosas / populacao *100000,1)
    ) %>% 
  ggplot() +
  geom_point(aes(x = tx_mort_inf, y = tx_doencas_infecciosas, color = desc_regiao)) +
  ggplot2::labs(
  title = 'Gráfico de dispersão entre a taxa de mortalidade infantil e taxa de doenças infecciosas e parasitárias',
  x = "Taxa de mortalidade infantil (por 1000 n.v.)",
  y = "Taxa de incidência de doenças infecciosas e parasitárias (por 100 mil hab.",
  color = "Região") + 
  facet_grid(vars(desc_regiao),vars(ano)) #Facetando por Região e ano
```

---

## Pacote Tidyverse (ggplot2)

**Gráfico de linha**

```{r eval=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}
dados_saude %>%
  filter(sigla_uf == "BA") %>% 
  group_by(ano) %>% 
  dplyr::mutate(
    tx_mort_inf = round(obitos_infantis / nascidos_vivos * 1000, 1),
    ) %>%
  ggplot(aes(x = ano , y = tx_mort_inf, label = tx_mort_inf)) +
  geom_line(color = "blue", size = 2) + #Aqui definimos a geometria "linha"
  geom_point(color = "blue", size = 4) + #Também queremos os pontos
  theme_classic() +
  geom_text(nudge_y = 0.25) + #Incluindo o label dos valores e sua altura
  ggplot2::labs(
  title = 'Taxa de mortalidade infantil (por 1000 n.v.). 2008-2020. Bahia',
  x = "Ano",
  y = "Taxa(por 1000 n.v.)")
```
---

## Pacote Tidyverse (ggplot2)


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6.5, fig.width=12}
dados_saude %>%
  filter(sigla_uf == "BA") %>% 
  group_by(ano) %>% 
  dplyr::mutate(
    tx_mort_inf = round(obitos_infantis / nascidos_vivos * 1000, 1),
    ) %>%
  ggplot(aes(x = ano , y = tx_mort_inf, label = tx_mort_inf)) +
  geom_line(color = "blue", size = 2) + #Aqui definimos a geometria "linha"
  geom_point(color = "blue", size = 4) + #Também queremos os pontos
  theme_classic() +
  geom_text(nudge_y = 0.25) + #Incluindo o label dos valores e sua altura
  ggplot2::labs(
  title = 'Taxa de mortalidade infantil (por 1000 n.v.). 2008-2020. Bahia',
  x = "Ano",
  y = "Taxa (por 1000 n.v.)")
```

---
## Pacote Tidyverse (ggplot2)

**Gráfico de bolhas**

```{r eval=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6, fig.width=12}
dados_saude %>%
  group_by(desc_regiao) %>%
  dplyr::mutate(
    tx_mort_inf = round(obitos_infantis / nascidos_vivos * 1000, 1),
    tx_doencas_infecciosas = round(doencas_infecciosas / populacao *100000,1)
    ) %>% 
  ggplot() +
  geom_point(aes(x = tx_mort_inf, y = tx_doencas_infecciosas,
                 size= populacao, color = desc_regiao)) + #size: tamanho da bolha pela dimensão
  #da população
  ggplot2::labs(
  title = 'Gráfico de dispersão entre a taxa de mortalidade infantil e taxa de doenças infecciosas e parasitárias',
  x = "Taxa de mortalidade infantil (por 1000 n.v.)",
  y = "Taxa de incidência de doenças infecciosas e parasitárias (por 100 mil hab.",
  color = "Região")
```


---
## Pacote Tidyverse (ggplot2)


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height=6.5, fig.width=12}
dados_saude %>%
  group_by(desc_regiao) %>%
  dplyr::mutate(
    tx_mort_inf = round(obitos_infantis / nascidos_vivos * 1000, 1),
    tx_doencas_infecciosas = round(doencas_infecciosas / populacao *100000,1)
    ) %>% 
  ggplot() +
  geom_point(aes(x = tx_mort_inf, y = tx_doencas_infecciosas,
                 size= populacao, color = desc_regiao)) + #size: tamanho da bolha pela
  #dimensão da população
  ggplot2::labs(
  title = 'Gráfico de dispersão entre a taxa de mortalidade infantil e taxa de doenças infecciosas e parasitárias',
  x = "Taxa de mortalidade infantil (por 1000 n.v.)",
  y = "Taxa de incidência de doenças infecciosas e parasitárias (por 100 mil hab.",
  color = "Região")
```

---
## Pacote Tidyverse (ggplot2)

Vamos trabalhar com **gráfico dinâmico**, também conhecido como **gráfico em movimento**. O banco de dados escolhido para gerar o gráfico contém uma série temporal dos países com PIB per capita, expectativa de vida e tamanho populacional.

```{r}

paises <- utils::read.csv(
  file = 'https://raw.githubusercontent.com/lcsfilho/Introducao_R/master/Curso%20R/bd/life-expectancy-vs-gdp-per-capita.csv',
  sep = ';',  dec = ',',  encoding = "UTF-8"
)
rmarkdown::paged_table(paises, options = list(rows.print=5))
```
---
## Pacote Tidyverse (ggplot2)

```{r eval=FALSE, message=F, warning=F, fig.width=15, fig.height=6.8}
library(plotly)

P_lot <-  ggplot(paises, aes(round(pib_per_capita, 0), expectativa_vida, size = populacao, fill = continente)) +
  geom_point(aes(frame = ano, ids = pais, colours="black", stroke = 0.0),  alpha=0.8) +
  ggplot2::labs(
    x = 'PIB per capita',
    y = 'Expectativa de vida',
    title = 'Gráfico dinâmico: Esperança de vida ao nascer, PIB per capita e População estimada. 1960-2018',
    caption = 'Fonte: https://ourworldindata.org/about',
    size = "População estimada",
    fill = "Continente",
    frame = "Ano"
    ) +
  theme_classic() +
  #personalizando as cores
  scale_fill_manual(values = c('#FC6342','#2CB1B8','#2F7BFA','#EACC26','#BF8BE1', '#6120F0')) +
  scale_size(range = c(2, 15), name="População")

ggplotly(P_lot)
```


---
## Pacote Tidyverse (ggplot2)

```{r echo=FALSE, message=F, warning=F, fig.width=15, fig.height=6.8}
library(plotly)

P_lot <-  ggplot(paises, aes(round(pib_per_capita, 0), expectativa_vida, size = populacao, fill = continente)) +
  geom_point(aes(frame = ano, ids = pais, colours="black", stroke = 0.0),  alpha=0.8) +
  ggplot2::labs(
    x = 'PIB per capita',
    y = 'Expectativa de vida',
    title = 'Gráfico dinâmico: Esperança de vida ao nascer, PIB per capita e População estimada. 1960-2018',
    caption = 'Fonte: https://ourworldindata.org/about',
    size = "População estimada",
    fill = "Continente",
    frame = "Ano"
    ) +
  theme_classic() +
  #personalizando as cores
  scale_fill_manual(values = c('#FC6342','#2CB1B8','#2F7BFA','#EACC26','#BF8BE1', '#6120F0')) +
  scale_size(range = c(2, 15), name="População")

  
ggplotly(P_lot)
```

---
## Pacote Tidyverse (ggplot2)

**Facetando o gráfico dinâmico**

```{r eval=FALSE, message=F, warning=F, fig.width=15, fig.height=6.8}
library(plotly)

P_lot <-  ggplot(paises, aes(round(pib_per_capita, 0), expectativa_vida, size = populacao, fill = continente)) +
  geom_point(aes(frame = ano, ids = pais, colours="black", stroke = 0.0),  alpha=0.8) +
  ggplot2::labs(
    x = 'PIB per capita',
    y = 'Expectativa de vida',
    title = 'Gráfico dinâmico: Esperança de vida ao nascer, PIB per capita e População estimada. 1960-2018',
    caption = 'Fonte: https://ourworldindata.org/about',
    size = "População estimada",
    fill = "Continente",
    frame = "Ano"
    ) +
  theme_bw() +
  #personalizando as cores
  scale_fill_manual(values = c('#FC6342','#2CB1B8','#2F7BFA','#EACC26','#BF8BE1', '#6120F0')) +
  scale_size(range = c(2, 15), name="População") +
  facet_wrap(~ continente, scales = "fixed")

  
ggplotly(P_lot)
```

---
## Pacote Tidyverse (ggplot2)

```{r echo=FALSE, message=F, warning=F, fig.width=15, fig.height=6.8}
library(plotly)

P_lot2 <-  ggplot(paises, aes(round(pib_per_capita, 0), expectativa_vida, size = populacao, fill = continente)) +
  geom_point(aes(frame = ano, ids = pais, colours="black", stroke = 0.0),  alpha=0.8) +
  ggplot2::labs(
    x = 'PIB per capita',
    y = 'Expectativa de vida',
    title = 'Gráfico dinâmico: Esperança de vida ao nascer, PIB per capita e População estimada. 1960-2018',
    caption = 'Fonte: https://ourworldindata.org/about',
    size = "População estimada",
    fill = "Continente",
    frame = "Ano"
    ) +
  theme_bw() +
  #personalizando as cores
  scale_fill_manual(values = c('#FC6342','#2CB1B8','#2F7BFA','#EACC26','#BF8BE1', '#6120F0')) +
  scale_size(range = c(2, 15), name="População") +
  facet_wrap(~ continente, scales = "fixed")

  
ggplotly(P_lot2)
```

---
# Mapas
Há vários pacotes para produção de mapas no R, mas vamos usar apenas dois: o `maptools` e o `leaflet`.

Para usar o o pacote `maptools`, devemos baixar malhas digitais. Um formato padrão de mapa digital é o _shapefile_. _Shapefile_ é um formato de armazenagem de dados vetoriais para
armazenar a posição, o formato e os atributos de feições geográficas.

_Shapefile- é um conjunto de, ao menos três arquivos:
- Arquivo com os polígonos (com extensão `.shp`);
- Arquivo com os atributos (com extensão `.dbf`);
- Arquivo com os índices (com extensão `.shx`).

Também há outros formatos de mapas que podem ser importados pelo `R`, como o formato `.rds`.

A forma usual de apresentação de dados agregados por áreas é o uso de _maps temáticos_.

---
## Mapas

Algumas páginas para baixar malhas digitais:

> [**StatSilk**](http://www.statsilk.com/maps/download-free-shapefile-maps) - http://www.statsilk.com/maps/download-free-shapefile-maps

</br>
> [**Natural Earth**](http://www.naturalearthdata.com/features/) - http://www.naturalearthdata.com/features/

</br>
> [**Global Administrative Areas (GADM)**](https://gadm.org/download_country.html) - https://gadm.org/download_country.html

</br>
> [**IBGE**](https://geoftp.ibge.gov.br/organizacao_do_territorio/malhas_territoriais/) - https://geoftp.ibge.gov.br/organizacao_do_territorio/malhas_territoriais/

---
background-image: url(https://github.com/lcsfilho/Introducao_R/blob/master/Curso%20R/fig/MalhaTerrit.PNG?raw=true)
background-size: 80%
background-position: 30% 95%

## Mapas

O `IBGE` disponibiliza centenas de mapas, desde mapas do Brasil divididos por municípios a mapas de municípios divididos por setores censitários. Na área de geociências é possível fazer downloads de cartas imagem, imagens aéreas e orbitais, mapas, malhas, além de conteúdos da INDE, atlas e arquivos Google Earth, entre outros.

</br>

**Importando mapas**

Vamos importar o mapa da Bahia subdividido em municípios, macro e mesorregiões, pela página do `IBGE`.


https://geoftp.ibge.gov.br/organizacao_do_territorio/malhas_territoriais/malhas_municipais/municipio_2021/UFs/BA/

---
## Mapas

```{r eval=-1, fig.align='center', fig.height=5, message=FALSE, warning=FALSE}
install.packages("maptools")
library(maptools)

# Malha digital da Bahia por municípios
bahia_mun = readShapeSpatial(
  "F:/Curso de R/Introducao_R/Curso R/malhadigital/BA_Municipios_2021/BA_Municipios_2021.shp"
  )

# Malha digital da Bahia por mesorregiões
bahia_mes = readShapeSpatial(
  "F:/Curso de R/Introducao_R/Curso R/malhadigital/BA_Mesorregioes_2021/BA_Mesorregioes_2021.shp"
  )


# Malha digital da Bahia por microrregiões
bahia_mic = readShapeSpatial(
  "F:/Curso de R/Introducao_R/Curso R/malhadigital/BA_Microrregioes_2021/BA_Microrregioes_2021.shp"
  )
```

---
## Mapas

Malha da Bahia por municípios
```{r  fig.align='center', fig.height=6.5, message=FALSE, warning=FALSE}
plot(bahia_mun)
```

---
## Mapas
.pull-left[
Malha da Bahia por microrregiões
```{r  fig.align='center', fig.height=6.5, message=FALSE, warning=FALSE}
plot(bahia_mic)
```

]

.pull-right[
Malha da Bahia por mesorregiões
```{r fig.align='center', fig.height=6.5, message=FALSE, warning=FALSE}
plot(bahia_mes)
```

]

---
## Mapas

Ajustando cores e linhas
```{r  fig.align='center', fig.height=6.5, message=FALSE, warning=FALSE}
plot(bahia_mun, col="gray", border="white")

```

---
## Mapas

O objeto `bahia_mun` contém:

> Um conjunto de polígonos, que representam os 417 municípios da Bahia;

> Uma tabela (`data.frame`) com alguns atributos dos municípios (417 linhas)

Espiando o data.frame associado ao objeto `bahia_mun`
```{r }
names(bahia_mun) #Leitura do cabeçalho do data-frame
head(data.frame(bahia_mun)) #Leitura das 5 primeiras linhas do data-frame

```

---
## Mapas
Vamos construir o mapa da taxa de mortalidade infantil.

**Atenção**: o código do município da sua tabela deve ser escrito exatamente igual ao código do município do `IBGE`, pois é por ele que as bases serão `ligadas`. O `R` já entende que a variável comum (chave) é **CD_MUN**.


```{r}
dados_mun_ba <- utils::read.csv(
  file = 'https://raw.githubusercontent.com/lcsfilho/Introducao_R/master/Curso%20R/bd/obitos_Infantis_nascidos_vivos_BA_mun_2020.csv',
  sep = ';', encoding = "UTF-8"
)
rmarkdown::paged_table(dados_mun_ba, options = list(rows.print=5))
```

---
## Mapas

Perceba que o conjunto de dados não possui a taxa de mortalidade infantil. Vamos calcular e incluir no `data-frame`. A coluna com o nome do município será removida, pois iremos unir esse banco ao objeto espacial, que já possui o nome do município.

```{r}
dados_mun_ba <- dados_mun_ba %>%
  select(CD_MUN, nasc_vivos, obitos_infantis) %>% #aqui não selecionamos o nome do município
  mutate(tx_mort_inf=round((obitos_infantis/nasc_vivos * 1000), 1))

rmarkdown::paged_table(dados_mun_ba, options = list(rows.print=5))
```
---
## Mapas

Agora, vamos criar uma nova tabela contendo o código do município, o nome do município, nascidos vivos, óbitos infantis e a taxa de mortalidade infantil. Faremos uma `merge` (união) entre o objeto espacial `bahia_mun` e o data-frame `dados_mun_ba`. Lembre que o `R` já entende que a variável comum `CD_MUN` é a chave.


```{r}
dados_txmort_BA = merge(bahia_mun@data, dados_mun_ba, sort=FALSE)
rmarkdown::paged_table(dados_txmort_BA, options = list(rows.print=5))
```


---
## Mapas
Mas `dados_txmort_BA` é uma classe de dados não-espacial, então vamos atribuir esse conjunto de dados ao `SpatialPolygonsDataFrame`, que consiste de uma classe de objetos para armazenar polígonos com seus atributos.

```{r}
bahia_mun@data = dados_txmort_BA #atribuímos os dados do data-frame ao objeto espacial
names(bahia_mun) #espiando como ficou
```





---
# Referências

```{r refs, echo=FALSE, results="asis"}
RefManageR::PrintBibliography(referencias)
```
